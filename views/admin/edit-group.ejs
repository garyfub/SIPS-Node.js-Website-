<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<%- include ../partials/default_header.ejs %>
<body>

<%- include ../partials/admin_navbar.ejs %>

<!-- Page Content -->
<div id="wrapper" class="container-fluid col-lg-10">

    <div class="row">
        <div class="container-fluid">


            <div class="col-lg-12">

                <div class="panel panel-default">
                    <div class="content">
                        <h1><%= groupName %></h1>
                        <p></p>
                    </div>
                </div>


                <div class="panel with-nav-tabs panel-default">
                    <div class="panel-heading">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#tabGroupInfo" data-toggle="tab">Group Info</a></li>
                            <li><a href="#tabUsers" data-toggle="tab">Members</a></li>
                            <li><a href="#tabPositions" data-toggle="tab">Positions</a></li>
                        </ul>
                    </div>
                    <br>
                    <div class="panel-body">
                        <div class="tab-content">

                            <!-- Group Info Tab -->
                            <div class="tab-pane fade in active" id="tabGroupInfo">
                                <form role="form" action="update-group" method="post" id="<%= groupID %>">
                                    <div class="form-group">
                                        <label for="group_name col-lg-2">Name:</label>
                                        <input type="text" class="form-control col-lg-7" id="group_name"
                                               name="group_name" value="<%= groupName %>" disabled>
                                    </div>
                                    <br><br>
                                    <button type="submit" class="btn btn-primary-outline"><i class="fa fa-wrench"></i> Edit</button>
                                </form>
                                <br>
                            </div>

                            <!-- Users Tab -->
                            <div class="tab-pane fade" id="tabUsers">
                                <table class="table table-striped table-hover table-radio">
                                    <thead>
                                    <tr class="active">
                                        <th class="col-lg-1 hidden">Select</th>
                                        <th class="col-lg-3">Name</th>
                                        <th class="col-lg-3">Position</th>
                                        <th class="col-lg-1">Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <% if(groupInfo.users.length == 0){ %>
                                    <tr class="warning">
                                        <td class="hidden"></td>
                                        <td>Hello! Please invite members and they will be displayed here</td>
                                        <td></td>
                                        <td>
                                            <a href="#" class="add_user btn btn-sm invisible"><span
                                                        class="fa fa-plus-square"></span> Invite New Members
                                            </a>
                                        </td>
                                    </tr>
                                    <% }
                                    for(var i = 0; i < groupInfo.users.length; i++){
                                    %>
                                    <td class="hidden"><input name="user" class="selectedUser" type="radio"
                                                              value="<%= groupInfo.users[i]["USERID"] %>"></td>
                                    <td><%= groupInfo.users[i]["NAME_LAST"] + ", " + groupInfo.users[i]["NAME_FIRST"] %></td>
                                    <td><%= groupInfo.users[i]["ROLE_NAME"] %></td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button"
                                                    class="action_btn btn btn-primary btn-sm dropdown-toggle invisible"
                                                    data-toggle="dropdown"><span class="fa fa-cog"></span></button>
                                            <ul class="dropdown-menu pull-right" role="menu">
                                                <li><a href="#" class="edit-user"><span class="fa fa-cog "></span> edit</a>
                                                </li>
                                                <li><a href="/results"><span class="fa fa-pie-chart "></span> View
                                                        User's Results</a></li>
                                                <li class="divider"></li>
                                                <li><a href="#" class="remove-user" data-toggle="modal" data-target="#remove-user-modal"><span
                                                                class="fa fa-trash-o "></span>
                                                        Remove user from group</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                    <% } %>
                                    </tbody>
                                </table>
                                <br>
                                <!-- Invite User -->
                                <a href="#" class="add_user btn btn-primary-outline"><span
                                            class="fa fa-plus-square"></span> Add new user
                                </a>
                            </div>


                            <!-- Positions Tab -->
                            <div class="tab-pane fade table-responsive" id="tabPositions">
                                <table class="table table-hover table-bordered table-radio">
                                    <thead>
                                    <tr class="active">
                                        <th class="col-lg-1 hidden">Select</th>
                                        <th class="col-lg-2">Position Name</th>
                                        <th class="col-lg-1">View Admin Dashboard</th>
                                        <th class="col-lg-1">Edit Groups</th>
                                        <th class="col-lg-1">Remove Members from Groups</th>
                                        <th class="col-lg-1">View Group Results</th>
                                        <th class="col-lg-1">Administer Tests</th>
                                        <th class="col-lg-1">Actions</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <% if(groupInfo.perms.length == 0){ %>
                                    <tr class="warning">
                                        <td class="hidden"></td>
                                        <td>Hello! Please add a position and they will be displayed here</td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td></td>
                                        <td>
                                            <a href="#" class="add_position btn btn-sm invisible"><span
                                                        class="fa fa-plus-square"></span> Add new position
                                            </a>
                                        </td>
                                    </tr>
                                    <% }
                                    for(var i = 0; i < groupInfo.perms.length; i++){
                                    %>
                                    <tr>
                                        <td class="hidden"><input name="position" class="selectedPos" type="radio"
                                                                  value="<%= groupInfo.perms[i]["ROLE_NAME"] %>"></td>
                                        <td><%= groupInfo.perms[i]["ROLE_NAME"] %></td>
                                        <td><%= groupInfo.perms[i]["VIEW_ORG_ADMIN_DASH"] == 1 ? "Yes":"No"%></td>
                                        <td><%= groupInfo.perms[i]["GROUP_EDITING"] == 1 ? "Yes":"No"%></td>
                                        <td><%= groupInfo.perms[i]["REMOVE_USERS"] == 1 ? "Yes":"No"%></td>
                                        <td><%= groupInfo.perms[i]["VIEW_GROUP_RESULTS"] == 1 ? "Yes":"No"%></td>
                                        <td><%= groupInfo.perms[i]["GIVE_TESTS"] == 1 ? "Yes":"No"%></td>

                                        <td>
                                            <div class="btn-group">
                                                <button type="button"
                                                        class="action_btn btn btn-primary btn-sm dropdown-toggle invisible"
                                                        data-toggle="dropdown"><span class="fa fa-cog"></span></button>
                                                <ul class="dropdown-menu pull-right" role="menu">
                                                    <li><a href="#" class="edit-perms"><span class="fa fa-cog "></span>
                                                            edit</a>
                                                    </li>
                                                    <li class="divider"></li>
                                                    <li><a href="#" class="delete-position" data-toggle="modal" data-target="#remove-position-modal"><span
                                                                    class="fa fa-trash-o "></span>
                                                            Delete Position</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </td>
                                    </tr>
                                    <% } %>
                                    </tbody>
                                </table>
                                <br>
                                <!-- Add new Position -->
                                <a href="#" class="add-position btn btn-primary-outline" data-toggle="modal" data-target="#add-position-modal"><span
                                            class="fa fa-plus-square"></span> Add new position
                                </a>
                            </div>

                        </div>
                    </div>

                </div>

            </div>
        </div>
    </div>
</div>
</div>

<!-- Add User popup dialog -->
<div id="add_user_box" title="Invite members to group">
    <span class="ui-state-default"><span class="ui-icon ui-icon-info"
                                         style="float:left; margin:0 7px 0 0;"></span></span>
    <div style="margin-left: 23px;">
        <p>
            Include email addresses to send the invite message to. Once submitted the default mail client on your device
            will open a new message with the message specified below.
        </p>
        <br><br>
        <form role="form">
            <div class="form-group">
                <label for="email_to" class="pull-left">TO:</label>
                <input type="text" class="form-control" id="email_to" name="email_to"
                       placeholder="example@gmail.com; example2@gmail.com">
            </div>
            <div class="form-group">
                <label for="email_subject" class="pull-left">Subject:</label>
                <input type="text" class="form-control" id="email_subject" name="email_subject"
                       value="SIPS Group Invitation">
            </div>
            <div class="form-group">
                <label for="email_body">Message body:</label>
                <p class="well">Hello, this is an invitation to join <%= groupName %> on SIPS. Please enter this code
                    after logging in with the Gmail account you want to use: <%= inviteCode %></p>
                <textarea type="text" class="form-control" id="email_body" name="email_body" rows="5"></textarea>
            </div>

        </form>
        <br>
    </div>
</div>


<!-- User Modal -->
<div id="remove-user-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Remove member confirmation</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove the member from the group?.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">No - Cancel</button>
                <button type="button" id="remove-user-confirmed" class="btn btn-danger" data-dismiss="modal">Yes</button>
            </div>
        </div>
    </div>
</div>

<!-- Position Removal Modal -->
<div id="remove-position-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Remove position confirmation</h4>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove this position from the group?.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">No - Cancel</button>
                <button type="button" id="remove-position-confirmed" class="btn btn-danger" data-dismiss="modal">Yes</button>
            </div>
        </div>
    </div>
</div>

<!-- Position Add Modal -->
<div id="add-position-modal" class="modal fade" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add New Position</h4>
            </div>
            <div class="modal-body">
                <p>Fill out form below</p>

                <form>
                    <div class="form-group">
                        <label for="new-pos-name">Position Name</label>
                        <input class="form-control" id="new-pos-name" placeholder="">
                    </div>

                    <br>
                    <label class="control-label">Permissions</label>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox"> Access to the Admin Dashboard <p class="text-danger pull-right"> (complete access)</p>
                        </label>
                    </div>

                    <div class="checkbox">
                        <label>
                            <input type="checkbox"> Able to edit basic group information
                        </label>
                    </div>

                    <div class="checkbox">
                        <label>
                            <input type="checkbox"> Able to remove members from a group
                        </label>
                    </div>

                    <div class="checkbox">
                        <label>
                            <input type="checkbox"> Able to view results of group members
                        </label>
                    </div>

                    <div class="checkbox">
                        <label>
                            <input type="checkbox"> Able to Administer tests via the SIPS app
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" id="remove-position-confirmed" class="btn btn-primary" data-dismiss="modal">Yes</button>
            </div>
        </div>
    </div>
</div>

<%- include ../partials/default_footer.ejs %>

<script>
    $(document).ready(function () {
        $(function () {
            $('#sideMenu').metisMenu();
        });

        //Initialize Add User dialog
        $("#add_user_box").dialog({
            autoOpen: false,
            modal: true,
            draggable: false,
            resizable: false,
            position: {my: "top", at: "bottom", of: '.navbar-fixed-top'},
            show: 'blind',
            hide: 'blind',
            width: 'auto',
            height: 'auto',
            dialogClass: 'ui-dialog',
            buttons: {
                "Open mail client": function () {
                    $(this).dialog("close");

                    var email = $('#email_to').val();
                    var subject = $('#email_subject').val();
                    var emailBody = 'Hello, this is an invitation to join <%= groupName %> on SIPS. Please enter this code after logging in with the Gmail account you want to use: <%= inviteCode %> . %0D%0A' + $('#email_body').val();
                    window.location = 'mailto:' + email + '?subject=' + subject + '&body=' + emailBody;
                },
                "Cancel": function () {
                    $(this).dialog("close");
                }
            }
        });

        //Check row on hover
        $('.table-radio tr').hover(
                function () {
                    $(this).find('td .btn').removeClass("invisible");
                },
                function () {
                    $(this).find('td input[type=radio]').prop('checked', true);
                    $(this).find('td .btn').addClass("invisible");
                }
        );

        //Open add user dialog
        $(".add_user").click(function () {
            $('#add_user_box').dialog('open');
        })

        //Send post to add position
        $('#add-position').click(function () {

            $.ajax({
                type: 'POST',
                url: '/admin/add-position',
                data: $('#new_position_form').serialize(),
                complete: function () {
                    window.location.reload(true);
                }
            });
        });

        //Post after confirmation to remove user
        $('#remove-user-confirmed').click(function () {
            var selectedUser = $('input[name=user]:checked').val()
            $.ajax({
                type: 'POST',
                url: '/admin/remove-user',
                data: {
                    userID: selectedUser,
                    groupID: '<%= groupID %>'
                },
                complete: function () {
                    window.location.reload(true);
                }
            });
        });

        //Post after confirmation to remove position
        $('#remove-position-confirmed').click(function () {
            var selectedPos = $('input[name=position]:checked').val()
            $.ajax({
                type: 'POST',
                url: '/admin/remove-position',
                data: {
                    position: selectedPos,
                    groupID: '<%= groupID %>'
                },
                complete: function () {
                    window.location.reload(true);
                }
            });
        });
    });


</script>

</body>
</html>
